rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Admin check - TEMPORARY: Using email until custom claims are available
    // TODO: Switch to custom claims when organization policy allows service account key creation
    // Note: Email-based check is less secure but works immediately without service account access
    function isAdmin() {
      return request.auth != null &&
             request.auth.token.email != null &&
             request.auth.token.email.lower() == "creeed22@gmail.com";
    }

    // Validate string length
    function isValidString(str, minLen, maxLen) {
      return str is string && str.size() >= minLen && str.size() <= maxLen;
    }

    // Validate required fields exist
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }

    // Quizzes - admin can read/write, anyone can read
    match /quizzes/{quizId} {
      allow read: if true;

      allow create: if isAdmin()
        && hasRequiredFields(['title', 'questions', 'createdAt'])
        && isValidString(request.resource.data.title, 1, 200)
        && request.resource.data.questions is list
        && request.resource.data.questions.size() >= 1
        && request.resource.data.questions.size() <= 100;

      allow update: if isAdmin()
        && hasRequiredFields(['title', 'questions', 'createdAt'])
        && isValidString(request.resource.data.title, 1, 200)
        && request.resource.data.questions is list
        && request.resource.data.questions.size() >= 1
        && request.resource.data.questions.size() <= 100;

      allow delete: if isAdmin();
    }

    // Sessions - admin can manage, players can only update their own answers/reactions
    match /sessions/{sessionId} {
      allow read: if request.auth != null;

      allow create: if isAdmin()
        && hasRequiredFields(['pin', 'quizId', 'players', 'status', 'createdAt', 'quiz'])
        && request.resource.data.pin is string
        && request.resource.data.pin.matches('^[0-9]{4}$')
        && request.resource.data.quiz is map;

      allow delete: if isAdmin();

      // Admin can update anything
      allow update: if isAdmin();

      // Players can join the session (add themselves to players map and initialize score)
      allow update: if request.auth != null
        && request.auth.uid in request.resource.data.players.keys()
        && !(request.auth.uid in resource.data.players.keys())
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['players', 'scores'])
        && (resource.data.status == 'lobby' || (resource.data.status == 'active' && resource.data.allowLateJoin == true));

      // Players can update their own answers, reactions, scores
      allow update: if request.auth != null
        && request.auth.uid in resource.data.players.keys()
        && request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['answers', 'reactions', 'scores', 'streaks', 'coldStreaks', 'badges']);
    }

    // Leaderboards - admin can manage, anyone can read
    match /leaderboards/{leaderboardId} {
      allow read: if true;

      allow create: if isAdmin()
        && hasRequiredFields(['name', 'createdAt'])
        && isValidString(request.resource.data.name, 1, 100);

      allow update: if isAdmin()
        && hasRequiredFields(['name', 'createdAt'])
        && isValidString(request.resource.data.name, 1, 100);

      allow delete: if isAdmin();
    }
  }
}
