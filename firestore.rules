rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Server-side admin check using custom claims (cannot be bypassed by client)
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }

    // Validate string length
    function isValidString(str, minLen, maxLen) {
      return str is string && str.size() >= minLen && str.size() <= maxLen;
    }

    // Validate required fields exist
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }

    // Quizzes - admin can read/write, anyone can read
    match /quizzes/{quizId} {
      allow read: if true;

      allow create: if isAdmin()
        && hasRequiredFields(['title', 'questions', 'createdAt'])
        && isValidString(request.resource.data.title, 1, 200)
        && request.resource.data.questions is list
        && request.resource.data.questions.size() >= 1
        && request.resource.data.questions.size() <= 100;

      allow update: if isAdmin()
        && hasRequiredFields(['title', 'questions', 'createdAt'])
        && isValidString(request.resource.data.title, 1, 200)
        && request.resource.data.questions is list
        && request.resource.data.questions.size() >= 1
        && request.resource.data.questions.size() <= 100;

      allow delete: if isAdmin();
    }

    // Sessions - admin can manage, players can only update their own answers/reactions
    match /sessions/{sessionId} {
      allow read: if request.auth != null;

      allow create: if isAdmin()
        && hasRequiredFields(['pin', 'quizId', 'players', 'status', 'createdAt'])
        && request.resource.data.pin is string
        && request.resource.data.pin.matches('^[0-9]{4}$');

      allow delete: if isAdmin();

      // Admin can update anything
      allow update: if isAdmin();

      // Players can only update specific fields (answers, reactions, scores)
      allow update: if request.auth != null
        && request.auth.uid in resource.data.players.keys()
        && request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['answers', 'reactions', 'scores', 'streaks', 'coldStreaks', 'badges']);
    }

    // Leaderboards - admin can manage, anyone can read
    match /leaderboards/{leaderboardId} {
      allow read: if true;

      allow create: if isAdmin()
        && hasRequiredFields(['name', 'createdAt'])
        && isValidString(request.resource.data.name, 1, 100);

      allow update: if isAdmin()
        && hasRequiredFields(['name', 'createdAt'])
        && isValidString(request.resource.data.name, 1, 100);

      allow delete: if isAdmin();
    }
  }
}
